# 国内镜像的配置及使用

## 阿里云

- 阿里云 - [https://www.aliyun.com/](https://www.aliyun.com/)
- 阿里云 - [登录](https://account.aliyun.com/)
- 阿里云 - [开发者平台](https://dev.aliyun.com/)
- 阿里云 - [容器Hub服务控制台](https://cr.console.aliyun.com/)

- 配置镜像加速器
  针对安装了Docker for Windows的用户，您可以参考以下配置步骤：
  在系统右下角托盘图标内右键菜单选择 Settings，打开配置窗口后左侧导航菜单选择 Docker Daemon。编辑窗口内的JSON串，填写下方加速器地址：

  ```sh
  {
  "registry-mirrors": ["https://sabuo78w.mirror.aliyuncs.com"]
  }
  ```

  编辑完成后点击 Apply 保存按钮，等待Docker重启并应用配置的镜像加速器。  
  docker-machine create --engine-registry-mirror=<https://sabuo78w.mirror.aliyuncs.com> -d hyperv default  
  Docker for Windows 有两种运行模式，同一时间只能选择一种模式运行。  
  - 一种运行Windows相关容器
  - 一种运行传统的Linux容器

- 配置镜像仓库
  1. 登录阿里云 `Docker Registry`  
    `$ sudo docker login --username=xxxxxx@qq.com registry.cn-hangzhou.aliyuncs.com`

      用于登录的用户名为阿里云账号全名，密码为开通服务时设置的密码。
      您可以在产品控制台首页修改登录密码。

  1. 从Registry中拉取镜像  
    $ sudo docker pull registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:[镜像版本号]

  1. 将镜像推送到 `Registry`  

      ```sh
      $ sudo docker login --username=xxxxxx@qq.com registry.cn-hangzhou.aliyuncs.com
      $ sudo docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:[镜像版本号]
      $ sudo docker push registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:[镜像版本号]
      请根据实际镜像信息替换示例中的[ImageId]和[镜像版本号]参数。
      $ docker tag 7d09e6f9ab82 registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:latest
      $ docker push registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:latest
      ```

  1. 选择合适的镜像仓库地址
    损耗您的公网流量。
    如果您使用的机器位于VPC网络，请使用 registry-vpc.cn-hangzhou.aliyuncs.com 作为Registry的域名登录，并作为镜像命名空间前缀。

  1. 示例
    使用"docker tag"命令重命名镜像，并将它通过专有网络地址推送至Registry。  
    $ sudo docker images

      ```sh
      REPOSITORY                                                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
      registry.aliyuncs.com/acs/agent                                    0.7-dfb6816         37bb9c63c8b2        7 days ago          37.89 MB
      ```

      $ sudo docker tag 37bb9c63c8b2 registry-vpc.cn-hangzhou.aliyuncs.com/acs/agent:0.7-dfb6816
      使用"docker images"命令找到镜像，将该镜像名称中的域名部分变更为Registry专有网络地址。

      $ sudo docker push registry-vpc.cn-hangzhou.aliyuncs.com/acs/agent:0.7-dfb6816

[镜像版本](https://cr.console.aliyun.com/repository/)

通过 dockerfile 创建 image 镜像，接下来我们开始创建容器。  

```sh
# 相对于 docker image build -t hiflask .
$ docker container run hiflask  
# 相对于 docker image build -t hiflask:0.0.1 .
$ docker container run hiflask:0.0.1
# or
$ docker run -d -it hiflask:0.0.1
```

```sh
# 拉取阿里云镜像仓库
docker pull registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:0.0.1
docker image ls --all
# 运行服务
docker container run registry.cn-hangzhou.aliyuncs.com/ubuntu_1804/ubuntu_wsl:0.0.1
```

```sh
$ docker container start containID
$ docker container stop containID
$ docker container logs containID
$ docker container cp containID:[/path/to/file] .
docker exec -it containID /bin/sh
```

## 发布 image 文件

容器运行成功后，就确认了 image 文件的有效性。这时，我们就可以考虑把 image 文件分享到网上，让其他人使用。

- [dockerhub](https://hub.docker.com/)

  `docker login`

- aliyun
  
  1. 卸载 docker-compose

      `sudo apt-get autoremove --purge docker-compose`

  1. 第一次输入阿里云登录账号密码
  1. 第二次输入 `registry` 密码 找到`固定密码`修改之
  1. 重新登录  
      `sudo docker login --username=xxx@qq.com registry.cn-hangzhou.aliyuncs.com`
