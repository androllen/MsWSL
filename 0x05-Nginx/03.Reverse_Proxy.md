<p align="center">
<img width="400" align="center" src="Assets/20190529160128.jpg"/>
<h2 align="center">配置反向代理，负载均衡实战解析</h2>
</p>

#### 前言
  A reverse proxy is a service that takes a client request, sends the request to one or more proxied servers, fetches the response, and delivers the server’s response to the client.

  Nginx 负载均衡 提供哪些优点：  
  - Load Balancing  
  - Caching  
  - SSL Termination  
  - Compression  

#### Nginx反向代理
- 基于HTTP服务的反向代理
- 基于非HTTP服务的反向代理

#### 基于HTTP服务的反向代理
  要将Nginx配置为```HTTP服务器的反向代理```，请打开域的服务器块配置文件，并在其中指定位置和代理服务器：
  ``` nginx
  server {
      listen 80;
      server_name www.example.com example.com;

      location /app {
        proxy_pass http://127.0.0.1:8080;
      }
  }
  ```
  代理服务器URL使用proxy_pass指令指定，可以使用HTTP或HTTPS作为协议，域名或IP地址，以及可选的端口和URI作为地址。  
  上面的配置告诉Nginx将所有请求传递/app到代理服务器的位置http://127.0.0.1:8080。  
  > 在基于Ubuntu和Debian的发行版上，服务器块文件存储在/etc/nginx/sites-available目录中，而在CentOS /etc/nginx/conf.d目录中。

  为了更好地说明指令location和proxy_pass指令的工作原理，我们采用以下示例：  
  ``` nginx
  server {
    listen 80;
    server_name www.example.com example.com;

    location /blog {
       proxy_pass http://node1.com:8000/wordpress/;
    }
  }
  ```
  如果访问者访问http://example.com/blog/my-post，Nginx将代理此请求http://node1.com:8000/wordpress/my-post。  
  当代理服务器的地址包含URI时，/wordpress/传递给代理服务器的请求URI将被指令中指定的URI替换。如果在没有URI的情况下指定代理服务器的地址，则将完整请求URI传递给代理服务器

#### 基于非HTTP服务的反向代理
  应用于 Gunicorn uwsgi  FastCGI 等
  ``` nginx
  server {
    listen 8080;                #你的服务器的端口
    server_name 你的服务器地址;  #例如 198.198.22.22 可以是域名，也可以写 ip 地址

    location / {
        proxy_pass http://127.0.0.1:5000; #这个是Gunicorn与Ningx通信的端口。和Gunicorn的配置相同
        access_log /root/flaskweb/access.log;
        error_log  /root/flaskweb/error.log;
      }
  }
  ```


  ``` nginx
    location / {
      proxy_pass http://127.0.0.1:8001; 
      proxy_http_version  1.1;
      proxy_cache_bypass  $http_upgrade;

      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        "upgrade";
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host  $host;
      proxy_set_header X-Forwarded-Port  $server_port;
    }
  ```

  - proxy_http_version 1.1 - 定义代理的HTTP协议版本，默认情况下设置为1.0。对于Websockets和keepalive连接，您需要使用1.1版。
  - proxy_cache_bypass $http_upgrade - 设置不从缓存中获取响应的条件。
  - Upgrade $http_upgrade和Connection "upgrade"-这些头字段，如果您的应用程序正在使用的WebSockets要求。
  - Host $host- $host以下优先顺序中的变量包含：请求行中的主机名，Host请求头字段中的主机名，或与请求匹配的服务器名称。
  - X-Real-IP $remote_addr - 将真实访问者远程IP地址转发到代理服务器。
  - X-Forwarded-For $proxy_add_x_forwarded_for - 包含客户端已通过代理的每个服务器的IP地址的列表。
  - X-Forwarded-Proto $scheme - 在HTTPS服务器块内使用时，代理服务器的每个HTTP响应都将重写为HTTPS。
  - X-Forwarded-Host $host - 定义客户端请求的原始主机。
  - X-Forwarded-Port $server_port - 定义客户端请求的原始端口。


#### 映射静态网页

#### 支持SSL
  [更安全的HTTPS](https://linuxize.com/post/secure-nginx-with-let-s-encrypt-on-ubuntu-18-04/)

#### 链接
[Nginx Docker](http://www.ruanyifeng.com/blog/2018/02/nginx-docker.html )  
[Nginx Reverse Proxy](https://linuxize.com/post/nginx-reverse-proxy/)  
[web-server/reverse-proxy](https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/)  
[nginx-reverse-proxy](https://linuxize.com/post/nginx-reverse-proxy/)  
https://www.cnblogs.com/chenhaoyu/p/10815122.html  
